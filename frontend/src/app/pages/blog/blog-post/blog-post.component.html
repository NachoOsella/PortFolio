@if (isLoading()) {
    <section class="section-block mx-auto max-w-4xl px-6 py-20">
        <div class="animate-pulse space-y-8">
            <div class="h-8 w-32 bg-[var(--bg1)]"></div>
            <div class="h-12 w-3/4 bg-[var(--bg1)]"></div>
            <div class="h-6 w-1/2 bg-[var(--bg1)]"></div>
            <div class="space-y-4">
                <div class="h-4 w-full bg-[var(--bg1)]"></div>
                <div class="h-4 w-5/6 bg-[var(--bg1)]"></div>
                <div class="h-4 w-4/6 bg-[var(--bg1)]"></div>
            </div>
        </div>
    </section>
} @else if (error()) {
    <section class="section-block mx-auto max-w-4xl px-6 py-20 text-center">
        <div class="border border-[#e55050]/30 bg-[var(--bg1)] p-12">
            <p class="text-[#e55050]">{{ error() }}</p>
            <a routerLink="/blog" class="btn-secondary mt-4 inline-flex">
                <lucide-icon [img]="icons.ArrowLeft" [size]="16" />
                Back to Blog
            </a>
        </div>
    </section>
} @else if (post()) {
    <article class="section-block mx-auto max-w-7xl px-6 py-20">
        <div class="post-layout">
            <aside
                class="post-toc-column"
                [class.post-toc-column-empty]="tocItems().length === 0"
                #tocColumn
            >
                <nav class="toc-shell p-0" aria-label="Table of contents">
                    <h2 class="mb-4 pl-2 text-sm font-bold uppercase tracking-wider text-[var(--gray)]">
                        Table of Contents
                    </h2>
                    <ul class="space-y-2.5">
                        @for (item of tocItems(); track item.id) {
                            <li>
                                <a
                                    (click)="scrollToSection(item.id); $event.preventDefault()"
                                    [href]="'#' + item.id"
                                    class="toc-link"
                                    [class.toc-link-active]="activeHeading() === item.id"
                                    [style.padding-left.px]="(item.level - 2) * 16"
                                    [attr.aria-current]="activeHeading() === item.id ? 'true' : null"
                                >
                                    {{ item.text }}
                                </a>
                            </li>
                        }
                    </ul>
                </nav>
            </aside>

            <div class="post-main-column">
                <a routerLink="/blog" class="btn-secondary" #backButton>
                    <lucide-icon [img]="icons.ArrowLeft" [size]="16" />
                    Back to Blog
                </a>

                <header class="post-header mt-8" #postHeader>
                    <p class="post-kicker">Article</p>

                    <h1 class="post-title text-[var(--fg)]" style="font-size: clamp(1.75rem, 3.5vw, 2.75rem); font-weight: 700; letter-spacing: -0.02em; line-height: 1.1;">
                        {{ post()!.title }}
                    </h1>

                    <div class="post-meta mt-5 flex flex-wrap items-center gap-4 text-sm text-[var(--gray)]">
                        <span class="post-meta-item">
                            <lucide-icon [img]="icons.Calendar" [size]="14" />
                            <time [attr.datetime]="post()!.date">{{ post()!.date | date: 'mediumDate' }}</time>
                        </span>
                    </div>

                    @if (post()!.tags.length) {
                        <ul class="post-tags mt-5" aria-label="Post tags">
                            @for (tag of post()!.tags; track tag) {
                                <li>
                                    <span class="post-tag">{{ tag }}</span>
                                </li>
                            }
                        </ul>
                    }
                </header>

                @if (tocItems().length > 0) {
                    <div class="mt-8 lg:hidden" #mobileToc>
                        <button
                            (click)="toggleToc()"
                            class="toc-mobile-toggle"
                            [attr.aria-expanded]="tocOpen()"
                            [attr.aria-controls]="tocPanelId"
                        >
                            <span class="toc-mobile-toggle-label">Table of Contents</span>
                            <span class="toc-mobile-toggle-icon" [class.toc-mobile-toggle-icon-open]="tocOpen()">
                                <lucide-icon [img]="icons.ChevronDown" [size]="17" />
                            </span>
                        </button>
                        @if (tocOpen()) {
                            <nav [id]="tocPanelId" class="toc-shell mt-3 p-0" aria-label="Table of contents">
                                <ul class="space-y-2.5">
                                    @for (item of tocItems(); track item.id) {
                                        <li>
                                            <a
                                                (click)="scrollToSection(item.id); $event.preventDefault()"
                                                [href]="'#' + item.id"
                                                class="toc-link"
                                                [class.toc-link-active]="activeHeading() === item.id"
                                                [style.padding-left.px]="(item.level - 2) * 16"
                                                [attr.aria-current]="activeHeading() === item.id ? 'true' : null"
                                            >
                                                {{ item.text }}
                                            </a>
                                        </li>
                                    }
                                </ul>
                            </nav>
                        }
                    </div>
                }

                <div class="mt-8" #contentContainerRef>
                    @if (post()!.coverImage) {
                        <div class="mb-8 border border-[var(--border-subtle)] bg-[var(--bg1)]">
                            <img
                                [ngSrc]="post()!.coverImage!"
                                [alt]="post()!.title"
                                width="1200"
                                height="630"
                                loading="lazy"
                                class="h-full w-full object-cover"
                            />
                        </div>
                    }

                    <div class="markdown-content max-w-none">
                        <markdown [data]="post()!.content"></markdown>
                    </div>

                    <div class="mt-12 border-t border-[var(--border-subtle)] pt-8">
                        <p class="text-sm font-medium text-[var(--gray)]">Share this post</p>
                        <div class="mt-3 flex gap-3">
                            <button
                                (click)="shareOnLinkedIn()"
                                class="inline-flex h-10 w-10 items-center justify-center border border-[var(--border-subtle)] text-[var(--fg)] transition-colors hover:border-[var(--border-strong)] hover:bg-[var(--bg2)]"
                                aria-label="Share on LinkedIn"
                            >
                                <lucide-icon [img]="icons.Linkedin" [size]="18" />
                            </button>
                            <button
                                (click)="copyLink()"
                                class="inline-flex h-10 w-10 items-center justify-center border border-[var(--border-subtle)] text-[var(--fg)] transition-colors hover:border-[var(--border-strong)] hover:bg-[var(--bg2)]"
                                aria-label="Copy link"
                            >
                                <lucide-icon [img]="icons.Link2" [size]="18" />
                            </button>
                        </div>
                    </div>
                </div>

                @if (prevPost() || nextPost()) {
                    <nav class="mt-16 grid grid-cols-1 gap-4 border-t border-[var(--border-subtle)] pt-8 sm:grid-cols-2" #postNav>
                        @if (prevPost()) {
                            <a
                                [routerLink]="['/blog', prevPost()!.slug]"
                                class="group border border-[var(--border-subtle)] p-4 transition-colors hover:border-[var(--border-strong)]"
                            >
                                <span class="text-xs font-medium text-[var(--gray)]">&larr; Previous</span>
                                <p class="mt-1 font-medium text-[var(--fg)] transition-colors group-hover:text-[var(--accent)]">
                                    {{ prevPost()!.title }}
                                </p>
                            </a>
                        } @else {
                            <div></div>
                        }

                        @if (nextPost()) {
                            <a
                                [routerLink]="['/blog', nextPost()!.slug]"
                                class="group border border-[var(--border-subtle)] p-4 text-right transition-colors hover:border-[var(--border-strong)]"
                            >
                                <span class="text-xs font-medium text-[var(--gray)]">Next &rarr;</span>
                                <p class="mt-1 font-medium text-[var(--fg)] transition-colors group-hover:text-[var(--accent)]">
                                    {{ nextPost()!.title }}
                                </p>
                            </a>
                        }
                    </nav>
                }
            </div>
        </div>
    </article>
}
